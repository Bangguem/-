<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room with Matching</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        #chat-container {
            max-width: 500px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #messages {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
            width: 100%;
        }

        #messageInput {
            width: calc(100% - 80px);
            padding: 8px;
        }

        #sendBtn,
        #matchBtn,
        #cancelBtn,
        #leaveBtn {
            padding: 8px;
            margin-top: 10px;
        }

        /* 채팅 관련 요소 숨기기 */
        #chat-section {
            display: none;
            width: 100%;
        }

        /* 사용자 정보 스타일 */
        #user-info,
        #partner-info {
            text-align: center;
            margin: 10px;
        }

        #user-info,
        #partner-info {
            margin-bottom: 10px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div id="chat-container">
        <button id="matchBtn">Request Match</button>
        <button id="cancelBtn" style="display: none;">Cancel Match</button>
        <button id="leaveBtn" style="display: none;">Leave Chat Room</button>

        <!-- 사용자 정보 표시 영역 -->
        <div id="user-info" style="display: none;">
            <h3>Your Info</h3>
            <p id="myNickname"></p>
            <p id="myAge"></p>
        </div>

        <div id="partner-info" style="display: none;">
            <h3>Partner Info</h3>
            <p id="partnerNickname"></p>
            <p id="partnerAge"></p>
        </div>

        <!-- 채팅 섹션 -->
        <div id="chat-section">
            <div id="messages"></div>
            <input id="messageInput" placeholder="Type a message..." autocomplete="off">
            <button id="sendBtn">Send</button>
        </div>
    </div>

    <script>
        const socket = io();

        // HTML Elements
        const matchBtn = document.getElementById('matchBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const chatSection = document.getElementById('chat-section');
        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');

        // User Info Elements
        const userInfo = document.getElementById('user-info');
        const partnerInfo = document.getElementById('partner-info');
        const myNickname = document.getElementById('myNickname');
        const myAge = document.getElementById('myAge');
        const partnerNickname = document.getElementById('partnerNickname');
        const partnerAge = document.getElementById('partnerAge');

        // Request Match
        matchBtn.addEventListener('click', () => {
            socket.emit('request normalmatch'); // Send match request to server
            matchBtn.style.display = 'none'; // Hide match button
            cancelBtn.style.display = 'block'; // Show cancel button
            messages.innerHTML = "Waiting for match...\n";
        });

        // Cancel Match
        cancelBtn.addEventListener('click', () => {
            socket.emit('cancel match'); // Send cancel match request to server
            matchBtn.style.display = 'block'; // Show match button
            cancelBtn.style.display = 'none'; // Hide cancel button
            messages.innerHTML = "Match request canceled.\n";
        });

        // Send chat message
        sendBtn.addEventListener('click', () => {
            const message = messageInput.value;
            if (message) {
                socket.emit('chat message', message); // Send message to server
                messageInput.value = ''; // Clear input
            }
        });

        // Receive chat message from server
        socket.on('chat message', (data) => {
            const item = document.createElement('div');
            item.textContent = `${data.username}: ${data.message}`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight; // Scroll to the bottom
        });


        // 이미 대기 중일 때 알림 받기
        socket.on('alreadyInQueue', (data) => {
            alert(data.message); // 알림 표시
            matchBtn.style.display = 'block'; // 매칭 버튼 다시 표시
            cancelBtn.style.display = 'none'; // 취소 버튼 숨기기
        });

        // Receive match success from server
        socket.on('matchSuccess', (data) => {
            // 매칭 성공 시 사용자 및 파트너 정보 표시
            myNickname.textContent = `Nickname: ${data.self.nickname}`;
            myAge.textContent = `Age: ${data.self.age}`;
            partnerNickname.textContent = `Nickname: ${data.partner.nickname}`;
            partnerAge.textContent = `Age: ${data.partner.age}`;

            userInfo.style.display = 'block';
            partnerInfo.style.display = 'block';
            chatSection.style.display = "block"; // Show chat section
            leaveBtn.style.display = "block"; // Show leave button
            cancelBtn.style.display = "none"; // Hide cancel button
            messages.innerHTML = `You have been matched with ${data.partner.nickname}\n`;
        });

        // Leave chat room
        leaveBtn.addEventListener('click', () => {
            socket.emit('leave room'); // Notify server to leave room
            matchBtn.style.display = 'block'; // Show match button
            chatSection.style.display = "none"; // Hide chat section
            userInfo.style.display = "none"; // Hide user info
            partnerInfo.style.display = "none"; // Hide partner info
            leaveBtn.style.display = "none"; // Hide leave button
            messages.innerHTML = ''; // Clear chat history
            alert("You have left the chat room.");
        });

        // Server response for leaving room
        socket.on('left room', () => {
            alert("You have left the chat room.");
        });
    </script>
</body>

</html>